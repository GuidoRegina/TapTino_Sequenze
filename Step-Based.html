<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Step-Based</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      margin: 0;
      background: black;
      color: white;
      font-family: Arial, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
    }
    .controls {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }
    input, button {
      font-size: 1rem;
      padding: 6px;
      border-radius: 4px;
    }
    #grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      grid-template-rows: repeat(5, 1fr);
      width: 17cm;
      height: 17cm;
      gap: 0.2cm;
      touch-action: manipulation;
    }
    .led {
      background-color: transparent;
      border: 1px solid #444;
      aspect-ratio: 1 / 1;
      width: 100%;
      transition: background-color 0.15s;
    }
    .on { background-color: white; }
    .correct { background-color: limegreen !important; }
    .wrong { background-color: red !important; }
  </style>
</head>
<body>

<div class="controls">
  <label for="userId">ID utente:</label>
  <input type="text" id="userId" placeholder="Ad es., 01">
  <button id="startBtn">Avvia</button>
  <button id="downloadBtn" disabled>Scarica Excel</button>
</div>

<div id="grid"></div>
<p id="status">Scelga la sequenza e inserisca un ID utente, poi prema "Avvia".</p>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script>
  const grid = document.getElementById("grid");
  const status = document.getElementById("status");
  const leds = [];
  const TRIALS_TOTAL = 36;
  let trial = 0;
  let userId = "";
  let currentIndex = null;
  let startTime = null;
  let results = [];

  for (let i = 0; i < 25; i++) {
    const led = document.createElement("div");
    led.className = "led";
    grid.appendChild(led);
    leds.push(led);
  }

  function randomIndex(exclude) {
    let idx;
    do {
      idx = Math.floor(Math.random() * 25);
    } while (idx === exclude);
    return idx;
  }

  function showLED() {
    if (trial >= TRIALS_TOTAL) return endSession();
    leds.forEach(l => l.className = "led");
    currentIndex = randomIndex(currentIndex);
    leds[currentIndex].classList.add("on");
    startTime = performance.now();
  }

  function feedback(index, correct) {
    leds[index].classList.remove("on");
    leds[index].classList.add(correct ? "correct" : "wrong");
    setTimeout(() => {
      leds[index].classList.remove("correct", "wrong");
    }, 150);
  }

  function computeISI(rt, correct) {
    const weight = (Math.min(rt, 1000) - 250) / 750;
    return Math.round(250 + (correct ? weight : 1) * (1000 - 250));
  }

  function handleTouch(index) {
    if (trial >= TRIALS_TOTAL) return;
    const now = performance.now();
    const rt = Math.round(now - startTime);
    const correct = index === currentIndex;
    feedback(index, correct);
    const isi = computeISI(rt, correct);

    results.push({
      Trial: trial + 1,
      User_ID: userId,
      RT_ms: rt,
      Accurate: correct ? 1 : 0,
      ISI_ms: isi,
      Timestamp: new Date().toISOString()
    });

    trial++;
    setTimeout(showLED, isi);
  }

  leds.forEach((led, index) => {
    led.addEventListener("touchstart", () => handleTouch(index), { passive: true });
  });

  function startSession() {
    userId = document.getElementById("userId").value.trim();
    if (!userId) return alert("Inserisca un ID utente valido.");
    results = [];
    trial = 0;
    status.textContent = "";
    document.getElementById("startBtn").disabled = true;
    document.getElementById("downloadBtn").disabled = true;
    showLED();
  }

  function endSession() {
    status.textContent = "Sessione completata.";
    document.getElementById("startBtn").disabled = false;
    document.getElementById("downloadBtn").disabled = false;
  }

  document.getElementById("startBtn").onclick = startSession;

  document.getElementById("downloadBtn").onclick = () => {
    const ws = XLSX.utils.json_to_sheet(results);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Risultati");
    XLSX.writeFile(wb, `step_based_${userId}.xlsx`);
  };
</script>

</body>
</html>

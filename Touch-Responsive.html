<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<title>Sequenza Touch-Responsive</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover" />
<style>
  html, body {
    margin: 0; padding: 0; height: 100%; width: 100%;
    background: black;
    display: flex;
    justify-content: center;
    align-items: center;
    overflow: hidden;
    -webkit-user-select: none;
    user-select: none;
    touch-action: manipulation;
    font-family: sans-serif;
  }
  .grid {
    width: 17cm;
    height: 17cm;
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    grid-template-rows: repeat(5, 1fr);
    gap: 0.2cm;
  }
  .grid.disabled {
    pointer-events: none;
    opacity: 0.5;
  }
  .led {
    background-color: transparent;
    border: 1px solid #333;
    aspect-ratio: 1 / 1;
    width: 100%;
    height: 100%;
    touch-action: manipulation;
    transition: background-color 0.15s ease;
  }
  .on {
    background-color: white;
  }
  .correct {
    background-color: limegreen !important;
  }
  .wrong {
    background-color: red !important;
  }
  .controls {
    position: fixed;
    top: 10px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    gap: 1rem;
    align-items: center;
    color: white;
    z-index: 10;
    background: rgba(0,0,0,0.5);
    padding: 8px 12px;
    border-radius: 8px;
  }
  button, input {
    font-size: 16px;
    padding: 6px 12px;
  }
  #message {
    position: fixed;
    bottom: 15px;
    width: 100%;
    text-align: center;
    font-size: 20px;
    color: white;
    user-select: none;
  }
</style>
</head>
<body>
  <div class="controls">
    <label>ID utente: <input type="text" id="userId" placeholder="Ad es., 01" autocomplete="off" /></label>
    <button id="startBtn">Avvia</button>
    <button id="download" disabled>Scarica Excel</button>
  </div>
  <div class="grid disabled" id="grid"></div>
  <div id="message">Scelga la sequenza e inserisca un ID utente, poi prema "Avvia"</div>

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script>
    const grid = document.getElementById('grid');
    const leds = [];
    const TRIALS_TOTAL = 36;
    const LEDS_ON_COUNT = 6;

    let allResults = [];
    let results = [];
    let userId = '';
    let trialCount = 0;
    let sessionActive = false;
    let activeIndices = [];

    // Inizializzo 25 LED
    for (let i = 0; i < 25; i++) {
      const led = document.createElement('div');
      led.classList.add('led');
      grid.appendChild(led);
      leds.push(led);
    }

    // Accende 6 LED bianchi casuali senza ripetizioni
    function lightUpSixLeds() {
      leds.forEach(led => led.classList.remove('on', 'correct', 'wrong'));
      const indices = [];
      while (indices.length < LEDS_ON_COUNT) {
        const idx = Math.floor(Math.random() * leds.length);
        if (!indices.includes(idx)) indices.push(idx);
      }
      indices.forEach(i => leds[i].classList.add('on'));
      return indices;
    }

    // Mostra feedback 150ms verde o rosso
    function showFeedback(idx, correct) {
      leds[idx].classList.remove('on');
      leds[idx].classList.add(correct ? 'correct' : 'wrong');
      setTimeout(() => {
        leds[idx].classList.remove('correct', 'wrong');
      }, 150);
    }

    // Funzione che gestisce il tocco su un LED
    function deactivateLed(idx) {
      if (!sessionActive) return;

      if (activeIndices.includes(idx)) {
        // Tocca LED acceso: corretto
        showFeedback(idx, true);
        activeIndices = activeIndices.filter(i => i !== idx);
        trialCount++;
        results.push({
          Trial: trialCount,
          User_ID: userId,
          Timestamp: new Date().toISOString(),
          LED_Index: idx + 1,
          Accurate: 1
        });

        if (trialCount >= TRIALS_TOTAL) {
          endSession();
          return;
        }

        // Se spenti tutti i 6 LED, accendi altri 6
        if (activeIndices.length === 0) {
          activeIndices = lightUpSixLeds();
        }

      } else {
        // Tocca LED spento: sbagliato
        showFeedback(idx, false);
        results.push({
          Trial: trialCount + 1,
          User_ID: userId,
          Timestamp: new Date().toISOString(),
          LED_Index: idx + 1,
          Accurate: 0
        });
      }
    }

    leds.forEach((led, idx) => {
      led.addEventListener('touchstart', () => {
        if (sessionActive) deactivateLed(idx);
      });
    });

    // Avvia sessione
    function startSession() {
      userId = document.getElementById('userId').value.trim();
      if (!userId) {
        alert('Inserisca un ID utente valido.');
        return;
      }
      results = [];
      trialCount = 0;
      sessionActive = true;
      activeIndices = lightUpSixLeds();
      grid.classList.remove('disabled');
      document.getElementById('startBtn').disabled = true;
      document.getElementById('download').disabled = true;
      document.getElementById('message').textContent = 'Tocchi i LED bianchi per spegnerli.';
    }

    // Termina sessione
    function endSession() {
      sessionActive = false;
      activeIndices = [];
      leds.forEach(led => led.classList.remove('on', 'correct', 'wrong'));
      grid.classList.add('disabled');
      allResults = allResults.concat(results);
      results = [];
      document.getElementById('message').textContent = "Sessione terminata. Inserisca un nuovo ID e prema 'Avvia' per iniziare.";
      document.getElementById('startBtn').disabled = false;
      document.getElementById('download').disabled = false;
    }

    // Eventi pulsanti
    document.getElementById('startBtn').addEventListener('click', startSession);

    document.getElementById('download').addEventListener('click', () => {
      if (allResults.length === 0) {
        alert('Nessun dato da scaricare.');
        return;
      }
      const ws = XLSX.utils.json_to_sheet(allResults);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Dati");
      XLSX.writeFile(wb, `risultati_tutti_utenti_touch-responsive.xlsx`);
    });

    // Setup iniziale pagina
    grid.classList.add('disabled');
    document.getElementById('download').disabled = true;
  </script>
</body>
</html>
